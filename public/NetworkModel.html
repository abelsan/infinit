<!DOCTYPE html>
<html>
    <head>
        <title>Network Model</title>
        <script type="text/javascript" src="js/ext/build/ext-all.js"></script>
        <link rel="stylesheet" type="text/css" href="js/ext/packages/ext-theme-neptune/build/resources/ext-theme-neptune-all.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="js/ext/src/ux/statusbar/css/statusbar.css" />
        <script type="text/javascript" src="js/ext/packages/ext-theme-neptune/build/ext-theme-neptune.js"></script>
        <script type="text/javascript" src="js/ext/packages/sencha-charts/build/sencha-charts-debug.js"></script>
        <link rel="stylesheet" type="text/css" href="js/ext/packages/sencha-charts/build/neptune/resources/sencha-charts-all.css" />
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
        <script src="js/UUID.js/dist/uuid.core.js">// If you only need UUID.generate() method </script>


<script>

var timeout_tol = 10000; // {ms} XHR calls timeout tolerance.

// Ext.Loader.setConfig({enabled: true});
Ext.Loader.setConfig({
    enabled: true,
    paths: {
        'Ext': './js/ext/src',
        'Ext.chart': './js/ext/packages/sencha-charts/src/chart',
        'Ext.draw': './js/ext/packages/sencha-charts/src/draw',
    },
});
// Ext.Loader.setPath('Ext', 'js/ext/src');
// Ext.Loader.setPath('Ext.chart', 'js/ext/packages/sencha-charts/src/chart');
// Ext.Loader.setPath('Ext.draw', 'js/ext/packages/sencha-charts/src/draw');
Ext.require([
    'Ext.ux.GMapPanel', // Alternative: https://gist.github.com/minibikini/1160378
    'Ext.ux.statusbar.StatusBar',
    'Ext.form.field.ComboBox',
    'Ext.chart.series.Pie',
    'Ext.chart.series.Polar',
]);

Ext.application({
    name: 'MyApp',

    launch: function () {

        var runModel;
        var initial_network = [];
        var current_network = [];
        // var simulation_result;

        Ext.getBody().setStyle('overflow', 'auto');

        // Generate a unique simulation identifier
        var generateSimID = function () {
            var simID = Ext.getCmp('simID');
            simID.setValue( UUID.generate() );
        };

		var bt_uploadHandler = function () {
		    var form = this.up('form').getForm();
		    if (form.isValid()) {
		        form.submit({
		            url: 'php', // Server API to upload a file
		            waitMsg: 'Uploading your file...',
		            success: function (fp, o) {
		                Ext.Msg.alert('Success', 'Your file "' + o.result.file + '" has been uploaded.');
		            }
		        });
		    }
		};

        // function fn_display_mode_changed() {
        //     if ( this.getValue() ){
        //         Ext.getCmp('cb_all_map_initial').setValue(false);
        //     }

        //     var h_map = Ext.getCmp('googleMap_initial').gmap;
        //     plotMap(h_map,current_network);
        // }
        var fn_display_mode_changed = function (me,which,network,markers) {
            if ( me.getValue() ){
                // Ext.getCmp('cb_all_map_'+which).setValue(false);
                Ext.getCmp('cb_all').setValue(false);
            }

            var h_map = Ext.getCmp('googleMap_'+which).gmap;
            plotMap(h_map,network,markers);
        };

        var records_costs = [];
        var total_cost_store = Ext.create('Ext.data.Store',{
            // fields : ['id','name'],
            fields: ['ind', 'value' ], // ind: indicator
            // data: records,
            data: records_costs,
            paging : false
        });

        // Wizard: http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html
        var original_map_style = [{
            "stylers": [{ "visibility": "off" }],
        },{
            "featureType": "administrative.country",
            "elementType": "geometry.stroke",
            "stylers": [{ "visibility": "on" }],
        },{
            "featureType": "administrative.country",
            "elementType": "labels.text",
            "stylers": [{ "visibility": "on" }],
        },{
            "featureType": "water",
            "elementType": "geometry.fill",
            "stylers": [{ "visibility": "on" }],
        },{
            "featureType": "administrative.locality",
            "elementType": "labels.icon",
            "stylers": [
                { "color": "#808080" },
                { "visibility": "simplified" },
            ],
        },{
            "featureType": "administrative.locality",
            "elementType": "labels.text",
            "stylers": [{ "visibility": "on" }],
        },{
        }];

        var w_description = new Ext.create('Ext.window.Window', {
            title: 'Description',
            height: 500,
            width: 500,
            layout: 'fit',
            scrollable: 'vertical',
            closeAction: 'hide',
            bodyPadding: 10,
            loader: {
                url: 'description.html',
                autoLoad: true,
            },
        });


        // main panel
        var childPanel1 = Ext.create('Ext.panel.Panel', {
            extend: 'Ext.container.Viewport',
            layout: 'border',
            height: 900,
            // height: '100%',
            // width: 1400,
            width: '100%',
            items: [{ // main north panel
                region: 'north',
                html: '<h1>KSA Water/Energy INFINIT Model 1.0</h1>',
                style: {
                    'text-align': 'center',
                    marginBottom: '10px',
                },
            }, { // main west panel
                region: 'west',
                title: 'Setup',
                width: 250,
                bodyPadding: 5,
                collapsible: true,
                items: [{
                    title: 'User info',
                    split: true,
                    bodyPadding: 5,
                    frame: true,
                    items: [{
                        xtype: 'form',
                        // defaultType: 'textfield',
                        items: [{
                            xtype: 'textfield',
                            fieldLabel: 'User ID',
                            id: 'userID',
                            name: 'userID',
                            value: 1,
                            readOnly: true,
                            width: '100%',
                        }, {
                            xtype: 'textfield',
                            fieldLabel: 'Simulation ID',
                            id: 'simID',
                            name: 'simID',
                            value: 123,
                            readOnly: true,
                            width: '100%',
                        }, {
                            xtype:'combo',
                            id: 'sessionID',
                            fieldLabel: 'Session',
                            name: 'sessionID',
                            queryMode:'local',
                            displayField:'display',
                            valueField:'value',
                            autoSelect:true,
                            forceSelection:true,
                            width: '100%',
                            store: Ext.create('Ext.data.Store', {
                                fields: ['value','display'],
                                data: [
                                    { 'value':123, 'display':'One' },
                                ],
                            }),
                            value: 123,
                            // readOnly: true,
                        }],
                    }]
                }, {
                    // west panel #1 for loading the database
                    region: 'west',
                    title: 'Step 1: Database ',
                    split: true,
                    bodyPadding: 5,
                    frame: true,
                    items: [{
                        xtype      : 'radiogroup',
                        fieldLabel : 'Use database',
                        layout: 'hbox',
                        id: 'db_src',
                        cls:'ver_list',
                        items: [{
                            boxLabel  : 'Default',
                            name      : 'db_src',
                            inputValue: 'src_default',
                            checked: true,
                        }, {
                            boxLabel  : 'New',
		                    name      : 'db_src',
		                    inputValue: 'src_new_file',
		                }]
                    }, {
                        xtype: 'filefield',
                        width: '100%',
                        name: 'file',
                        msgTarget: 'side',
                        allowBlank: false,
                        anchor: '100%',
                        buttonText: 'Select File',
                        disabled: true,
                        // enctype: 'multipart/form-data',
                    }, {
                        xtype: 'button',
                        text: 'Upload',
                        id: 'b_upload_file',
                        disabled: true,
                        handler: function() {
                            bt_uploadHandler();
                        },
                    }]
                }, {
                    // west panel #2 for inputs
                    region: 'west',
                    title: 'Step 2: Optimization ',
                    split: true,
                    bodyPadding: 5,
                    frame: true,
                    items: [{
                        html: '<p>Optimize Network Flow under:</p>',
                    }, {
                        // TODO:
                        //      Append the current slider value
                        //      at the end of the label.
                        //      http://jsfiddle.net/molecule/WdjZn/
                        //      http://www.sencha.com/forum/showthread.php?184084-Display-slider-value
                        xtype: 'sliderfield',
                        fieldLabel: 'Cost (%)',
                        // labelStyle: 'color:gray; margin-bottom:0px;',
                        // afterLabelTextTpl: this.getValue()+'%',
                        id: 's_cost',
                        width: '100%',
                        value: 100,
                        minValue: 0,
                        maxValue: 100,
                        listeners: {
                            change: function( slider, newValue, thumb, eOpts ) {
                                Ext.getCmp('s_co2').setValue(100 - slider.getValue());
                            },
                        },
                    }, {
                        xtype: 'sliderfield',
                        fieldLabel: 'CO2 (%)',
                        id: 's_co2',
                        width: '100%',
                        value: 0,
                        minValue: 0,
                        maxValue: 100,
                        listeners: {
                            change: function( slider, newValue, thumb, eOpts ) {
                                Ext.getCmp('s_cost').setValue(100 - slider.getValue());
                            },
                        },
                    }, {
                        defaultType: 'textfield',
                        items: [{
                            fieldLabel: 'Time Limit (Seconds)',
                            id: 'timelimit',
                            name: 'TimeLimit',
                            value: 30,
                            width: '100%',
                        }, {
                            fieldLabel: 'Optimality Gap',
                            id: 'optimality',
                            name: 'optimalityGap',
                            value: 0.03,
                            width: '100%',
                        }],
                    }, {
                        xtype: 'button',
                        text: 'Run',
                        id: 'b_run_model',
                        handler: function() {
                            var h_map = Ext.getCmp('googleMap_optimized').gmap;
                            runModel(h_map);
                        },
                    }, {
                        xtype: 'statusbar',
                        id: 'sb_run_status',
                        // width: 220,
                        width: 170,
                        statusAlign: 'right', // the magic config
                        // defaults to use when the status is cleared:
                        defaultText: 'Ready',
                        defaultIconCls: 'default-icon',
                        style: {
                            display: 'inline-block',
                        },
                    }],
                }, {
                    xtype: 'panel',
                    id: 'p_description',
                    title: 'Description',
                    bodyPadding: 5,
                    height: 85,
                    split: true,
                    frame: true,
                    listeners: {
                        click: {
                            element: 'el', //bind to the underlying el property on the panel
                            fn: function() {
                                w_description.show();
                            },
                        },
                    },
                    items: [{
                        xtype: 'box',
                        loader: {
                            url: 'description.html',
                            autoLoad: true,
                        },
                        style: {
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap',
                        },
                    }],
                }],
            }, { // main center panel
                // itemId: 'centerregion',
                region: 'center',
                // bodyPadding: 5,
                // xtype:'container',
                layout: 'hbox',
                items: [{ // center panel #1 -> google map + display modes
                    bodyPadding: 5,
                    items: [{
                        title: 'Initial network 2010',
                        itemId: 'centerregion_initial',
                        frame: 'true',
                        // width: 700,
                        width: 600,
                        height: 550,
                        layout:'fit',
                        items: [{
                            xtype: 'gmappanel',
                            gmapType: 'map',
                            id: 'googleMap_initial',
                            center: {
                                lat: 24.7,
                                lng: 46.7,
                            },
                            // mapConfOpts: ['enableScrollWheelZoom','enableDoubleClickZoom','enableDragging'],
                            mapOptions: {
                                zoom: 5,
                                mapTypeId: google.maps.MapTypeId.ROADMAP,
                                styles: original_map_style,
                            },
                        }],
                    }, {
                        bodyPadding: 5,
                        items: [{
                            xtype: 'checkboxgroup',
                            fieldLabel: 'Layers',
                            id: 'cb_display_group',
                            name: 'cb_display_group',
                            columns: 5,
                            bodyPadding: 5,
                            items: [{
                                boxLabel: 'All ',
                                id: 'cb_all',
                                name: 'cb_display',
                                inputValue: '1',
                                checked: true,
                                handler: function () {
                                    if ( this.getValue() ){
                                        Ext.getCmp('cb_pipeline').setValue(false);
                                        Ext.getCmp('cb_city').setValue(false);
                                        Ext.getCmp('cb_power').setValue(false);
                                        Ext.getCmp('cb_desal').setValue(false);
                                    }

                                    var h_map = Ext.getCmp('googleMap_initial').gmap;
                                    plotMap(h_map,initial_network,markers_initial);
                                    if ( current_network.length !== 0 ) {
                                        h_map = Ext.getCmp('googleMap_optimized').gmap;
                                        plotMap(h_map,current_network,markers_optimized);
                                    }
                                }
                            }, {
                                boxLabel: 'Pipelines',
                                id: 'cb_pipeline',
                                name: 'cb_display',
                                inputValue: '2',
                                handler: function () {
                                    fn_display_mode_changed(this,'initial',initial_network,markers_initial);
                                    if ( current_network.length !== 0 )
                                        fn_display_mode_changed(this,'optimized',current_network,markers_optimized);
                                 },
                            }, {
                                boxLabel: 'City',
                                id: 'cb_city',
                                name: 'cb_display',
                                inputValue: '3',
                                handler: function () {
                                    fn_display_mode_changed(this,'initial',initial_network,markers_initial);
                                    if ( current_network.length !== 0 )
                                        fn_display_mode_changed(this,'optimized',current_network,markers_optimized);
                                 },
                            }, {
                                boxLabel: 'Power Plant',
                                id: 'cb_power',
                                name: 'cb_display',
                                inputValue: '4',
                                handler: function () {
                                    fn_display_mode_changed(this,'initial',initial_network,markers_initial);
                                    if ( current_network.length !== 0 )
                                        fn_display_mode_changed(this,'optimized',current_network,markers_optimized);
                                 },
                            }, {
                                boxLabel: 'Desalination Plant',
                                id: 'cb_desal',
                                name: 'cb_display',
                                inputValue: '5',
                                handler: function () {
                                    fn_display_mode_changed(this,'initial',initial_network,markers_initial);
                                    if ( current_network.length !== 0 )
                                        fn_display_mode_changed(this,'optimized',current_network,markers_optimized);
                                 },
                            }, {
                                boxLabel: 'Legend',
                                id: 'cb_legend',
                                name: 'cb_display',
                                inputValue: '6',
                                checked: true,
                                handler: function () {
                                    var o_map = Ext.get('legend_map_optimized');
                                    if ( this.getValue() ) { // Show legend
                                        Ext.get('legend_map_initial').setStyle('display', 'block');
                                        if (o_map !== null) o_map.setStyle('display', 'block');
                                    } else { // Hide legend
                                        Ext.get('legend_map_initial').setStyle('display','none');
                                        if (o_map !== null) o_map.setStyle('display', 'none');
                                    }
                                },
                            }],
                        }],
                    }],
                }, { // Optimized network map
                    bodyPadding: 5,
                    items: [{
                        items: [{
                            title: 'Optimized network 2030',
                            itemId: 'centerregion_optimized',
                            frame: 'true',
                            // width: 700,
                            width: 600,
                            height: 550,
                            layout:'fit',
                            items: [{
                                xtype: 'gmappanel',
                                gmapType: 'map',
                                id: 'googleMap_optimized',
                                center: {
                                    lat: 24.7,
                                    lng: 46.7,
                                },
                                // mapConfOpts: ['enableScrollWheelZoom','enableDoubleClickZoom','enableDragging'],
                                mapOptions: {
                                    zoom: 5,
                                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                                    styles: original_map_style,
                                },
                            }],
                        }],
                    }, {
                        // bodyPadding: 5,
                        // items: [{
                        //     xtype: 'checkboxgroup',
                        //     fieldLabel: 'Display Modes',
                        //     id: 'cb_display_group_map_optimized',
                        //     name: 'cb_display_group_map_optimized',
                        //     columns: 5,
                        //     bodyPadding: 5,
                        //     items: [{
                        //         boxLabel: 'All ',
                        //         id: 'cb_all_map_optimized',
                        //         name: 'cb_display_map_optimized',
                        //         inputValue: '1',
                        //         checked: true,
                        //         handler: function () {
                        //             if ( this.getValue() ){
                        //                 Ext.getCmp('cb_pipeline_map_optimized').setValue(false);
                        //                 Ext.getCmp('cb_city_map_optimized').setValue(false);
                        //                 Ext.getCmp('cb_power_map_optimized').setValue(false);
                        //                 Ext.getCmp('cb_desal_map_optimized').setValue(false);
                        //             }

                        //             var h_map = Ext.getCmp('googleMap_optimized').gmap;
                        //             plotMap(h_map,current_network);
                        //         }
                        //     }, {
                        //         boxLabel: 'Pipelines',
                        //         id: 'cb_pipeline_map_optimized',
                        //         name: 'cb_display_map_optimized',
                        //         inputValue: '2',
                        //         handler: function () { fn_display_mode_changed('optimized'); },
                        //     }, {
                        //         boxLabel: 'City',
                        //         id: 'cb_city_map_optimized',
                        //         name: 'cb_display_map_optimized',
                        //         inputValue: '3',
                        //         handler: function () { fn_display_mode_changed('optimized'); },
                        //     }, {
                        //         boxLabel: 'Power Plant',
                        //         id: 'cb_power_map_optimized',
                        //         name: 'cb_display_map_optimized',
                        //         inputValue: '4',
                        //         handler: function () { fn_display_mode_changed('optimized'); },
                        //     }, {
                        //         boxLabel: 'Desalination Plant',
                        //         id: 'cb_desal_map_optimized',
                        //         name: 'cb_display_map_optimized',
                        //         inputValue: '5',
                        //         handler: function () { fn_display_mode_changed('optimized'); },
                        //     }, {
                        //         boxLabel: 'Legend',
                        //         id: 'cb_legend_map_optimized',
                        //         name: 'cb_display_map_optimized',
                        //         inputValue: '6',
                        //         checked: true,
                        //         handler: function () {
                        //             if ( this.getValue() ) { // Show legend
                        //                 Ext.get('legend_map_optimized').setStyle('display', 'block');
                        //             } else { // Hide legend
                        //                 Ext.get('legend_map_optimized').setStyle('display','none');
                        //             }
                        //         },
                        //     }],
                        // }],
                    }],
                    // }],
                }],
            }, { // main East panel
                region: 'east',
                // width: 300,
                width: 300,
                // width: '100%',
                bodyPadding: 5,
                items: [{
                    // east panel #1 shows results
                    // title: 'Results',
                    title: 'KPIs',
                    split: false,
                    bodyPadding: 5,
                    frame: true,
                    collapsible: true,
                    width: 300,
                    items: [{
                        defaultType: 'textfield',
                        defaults: {
                            labelWidth: 180,
                            width: '100%',
                        },
                        items: [{
                            fieldLabel: 'Optimization terminated due to',
                            id: 'OptiTermDueTo',
                            name: 'OptiTermDueTo',
                            readOnly: true,
                            value: 'Not started',
                            labelWidth: 110,
                            width: '100%',
                            // width: '100%',
                        }, {
                            fieldLabel: 'Total Cost (MUSD/year)',
                            id: 'kpi_cost',
                            name: 'TotalCost',
                            readOnly: true,
                            value: '0.0',
                            // labelWidth: '150',
                            // width: '100%',
                            // layout: 'fit',
                        }, {
                            fieldLabel: 'Total CAPEX (MUSD/year)',
                            id: 'kpi_CAPEX',
                            name: 'TotalCAPEX',
                            readOnly: true,
                            value: '0.0',
                            // width: '100% - 150',
                            // labelWidth: '150',
                            labelAlign: 'right',
                        }, {
                            fieldLabel: 'Total OPEX (MUSD/year)',
                            id: 'kpi_OPEX',
                            name: 'TotalOPEX',
                            readOnly: true,
                            value: '0.0',
                            // labelWidth: '150',
                            // width: '90%',
                            labelAlign: 'right',
                        }, {
                            fieldLabel: 'Total CO2 Emission (MMT/year)',
                            id: 'kpi_CO2',
                            name: 'TotalCO2',
                            readOnly: true,
                            value: '0.0',
                            // width: '100%',
                            // labelWidth: '150',
                        }, {
                            fieldLabel: 'Total Potable Water Production (MCM/year)',
                            id: 'kpi_potable',
                            name: 'TotalPotableWater',
                            readOnly: true,
                            value: '0.0',
                            // width: '100%',
                            // labelWidth: '150',
                        }, {
                            fieldLabel: 'Total Water loss in Pipeline (%)',
                            id: 'kpi_totalLossWater',
                            name: 'TotalWaterLoss',
                            readOnly: true,
                            value: '0.0',
                            // width: '100%',
                            // labelWidth: '150',
                            labelAlign: 'right',
                        }, {
                            fieldLabel: 'Total Electricity Generation (GWh/year)',
                            id: 'kpi_electricity',
                            name: 'TotalElectricity',
                            readOnly: true,
                            value: '0.0',
                            // width: '100%',
                            // labelWidth: '150',
                        }],
                    }],
                }, {
                    title: 'Graphs',
                    xtype: 'panel',
                    // split: true,
                    bodyPadding: 5,
                    width: 300,
                    // height: 400,
                    // layout: 'fit',
                    // frame: true,
                    split: false,
                    frame: true,
                    collapsible: true,
                    items: [{
                        xtype: 'panel',
                        items: [{
                            xtype: 'polar',
                            id: 'graph_total_cost',
                            width: '100%',
                            height: 300,
                            insetPadding: 50,
                            innerPadding: 20,
                            // legend: {
                            //     docked: 'bottom',
                            // },
                            interactions: ['rotate', 'itemhighlight'],
                            store: total_cost_store,
                            // store: Ext.create('Ext.data.JsonStore', {
                            //     fields: ['ind', 'value' ], // ind: indicator
                            //     data: records_costs,
                            //     // [
                            //         // { ind: 'CAPEX', value: 68.3 },
                            //         // { ind: 'OPEX', value: 31.7 },
                            //     // ],
                            // }),
                            sprites: [{
                                type: 'text',
                                text: 'Total Cost (MUSD/year)',
                                fontSize: 15,
                                width: 100,
                                height: 30,
                                x: 40, // the sprite x position
                                y: 20  // the sprite y position
                            }],
                            series: [{
                                type: 'pie',
                                angleField: 'value',
                                label: {
                                    field: 'ind',
                                    calloutLine: {
                                        length: 30,
                                        width: 3,
                                        // specifying 'color' is also possible here
                                    },
                                },
                                highlight: true,
                                tooltip: {
                                    trackMouse: true,
                                    renderer: function(storeItem, item) {
                                        // this.setHtml(storeItem.get('ind') + ': ' + storeItem.get('value') + '%');
                                        this.setHtml( storeItem.get('ind') + ': ' + storeItem.get('value') );
                                    },
                                },
                            }],
                        }],
                    }],
                }],
            }],
        }); // childPanel1

        // New pareto graph
        //  xlabel: 'Total Cost (CAPEX+OPEX) [BUSD/year]'
        //  ylabel: 'Total CO2 Emission [MMT/year]'

        Ext.create('Ext.container.Viewport', {
            items: [childPanel1]
        });

        var sb = Ext.getCmp('sb_run_status');


        //////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////
        // from: index.html
        //

		var map_handler = {"map":null,"options":null};
        var markers_initial = [];
		var markers_optimized = [];

		var domain_name = window.location.hostname;
		var server_addr = domain_name + ':8080';

		var showInitialNetwork = function (h_map) {
            sb.showBusy('Loading network...');
            var in_userID = Ext.getCmp('userID').getValue().trim();
            var in_simID = Ext.getCmp('simID').getValue().trim();
            var in_sessionID = Ext.getCmp('sessionID').getValue();
            //var in_sessionID = Ext.getCmp('sessionID').getValue();

            var resource = 'http://' + server_addr + '/initial_network?'+
                'userID=' + in_userID +
                '&sessionID=' + in_sessionID +
                '&src=' + Ext.getCmp('db_src').getChecked()[0].inputValue ;

            // Request user data through an XHR.
            Ext.Ajax.request({
                url: resource,
                success: function(response, opts) {
                    var obj = Ext.decode(response.responseText);

                    if ( obj !== null ) {
                        initial_network = obj; // Backup results gotten from the server.
                        // current_network = initial_network;

                        sb.showBusy('Plotting...');
                        plotMap(h_map,initial_network,markers_initial);
                        insertLegend(h_map,initial_network,'map_initial');

                        sb.setStatus({
                            iconCls: 'x-status-valid',
                            text: 'Finished',
                            clear: { wait: 1000, },
                        });
                    }
                },
                failure: function(response, opts) {
                    console.log('server-side failure with status code ' + response.status);
                    sb.setStatus({
                        text: 'Finished with error',
                        iconCls: 'x-status-error',
                    });
                }
            });
        };

        runModel = function(h_map) {
            Ext.getCmp('b_run_model').setDisabled(true);
            sb.showBusy('Running simulation...'); // Set the status bar to show that something is processing:

            var in_userID = Ext.getCmp('userID').getValue().trim();
            var in_simID = Ext.getCmp('simID').getValue().trim();
            var in_sessionID = Ext.getCmp('sessionID').getValue();
            var in_cost = Ext.getCmp('s_cost').getValue()/100;
            var in_co2 = Ext.getCmp('s_co2').getValue()/100;
            var in_timelimit = Ext.getCmp('timelimit').getValue().trim();
            var in_optimality = Ext.getCmp('optimality').getValue().trim();

            var resource = 'http://' + server_addr + '/output?' +
                        'userID=' + in_userID +
                        '&simID=' + in_simID +
                        '&sessionID=' + in_sessionID +
                        '&cost=' + in_cost +
                        '&co2=' + in_co2 +
                        '&timelimit=' + in_timelimit +
                        '&optimality=' + in_optimality;
            // console.log('resource: ' + resource);

            var total_timeout = in_timelimit + timeout_tol;

            // Request user data through an XHR.
            Ext.Ajax.request({
                url: resource,
                timeout: total_timeout,
                success: function(response, opts) {
                    var obj = Ext.decode(response.responseText);
                    // console.dir(obj);

                    // Backup results gotten from the server.
                    current_network = obj;

                    sb.showBusy('Plotting...');
                    // Change 'panned' desal plants to 'existing'
                    for (var i = current_network.msg.data.outputs.nodes.length - 1; i >= 0; i--) {
                        var node = current_network.msg.data.outputs.nodes[i];
                        if ( node[0] === 'desal' && node[1] === 'candid' )
                            node[1] = 'existing';
                    }
                    // markers_optimized = [];
//                     deleteMarkers(markers_optimized);
                    plotMap(h_map,current_network,markers_optimized);
                    insertLegend(h_map,current_network,'map_optimized');
                    updateIndicators(current_network);

                    console.log('stdout: '+ current_network.msg.stdout);
                    console.log('stderr: '+ current_network.msg.stderr);
                    // Done.

                    // Generate a new unique Simulation ID
                    generateSimID();
                    // and enable the run button
                    Ext.getCmp('b_run_model').setDisabled(false);
                    sb.setStatus({
                        iconCls: 'x-status-valid',
                        text: 'Finished',
                    });
                },
                failure: function(response, opts) {
                    console.log('server-side failure with status code: ' + statusText + ' (Code '+ response.status + ')');
                    console.dir(response);
                    // Generate a new unique Simulation ID
                    generateSimID();
                    // and enable the run button
                    Ext.getCmp('b_run_model').setDisabled(false);
                    sb.setStatus({
                        iconCls: 'x-status-error',
                        text: 'Finished with error',
                    });
                }
            });
        };

        // var insertLegend = function (h_map) {
        var insertLegend = function (h_map,the_network,id) {
            var legend,
				content = [],
                elem,
                radius = 5,
                is_initial_network;

			// Create the legend and display on the map
			legend = document.createElement('div');
            // legend.id = 'legend';
			legend.id = 'legend'+'_'+id;
            legend.classList.add("legend");
			content.push('<h3>Legend</h3>');

            is_initial_network = ( the_network.msg.data.id !== undefined && the_network.msg.data.id === "initial_network" );
            elem = map_design_format.city.with_wastewater_treatment;
            content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
            elem = map_design_format.city.without_wastewater_treatment;
            content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");

            if ( is_initial_network ) {
                elem = map_design_format.desal.existing;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
                elem = map_design_format.desal.candid;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
            } else {
                elem = map_design_format.desal.existing;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShorter + "</p>");
            }

            if ( is_initial_network ) {
                elem = map_design_format.power.power;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
            } else {
                elem = map_design_format.power.power;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShorter + "</p>");
            }

            if ( is_initial_network ) {
                elem = map_design_format.pipeline.existing;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.name + "</p>");
                elem = map_design_format.pipeline.candid;
                content.push("<p><svg height='5' width='15'>"+
                    "<rect x='0' y='0' height='5' width='5' fill='"+elem.strokeColor+"' />"+
                    "<rect x='5' y='0' height='5' width='5' fill='#FFFFFF' />"+
                    "<rect x='10' y='0' height='5' width='5' fill='"+elem.strokeColor+"' />"+
                    "</svg>  "+ elem.nameShort + "</p>");
            } else {
                elem = map_design_format.pipeline.existing;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.nameShort + "</p>");
                elem = map_design_format.pipeline.new;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.nameShort + "</p>");
                elem = map_design_format.pipeline.unused;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.nameShort + "</p>");
            }

            legend.innerHTML = content.join('');
            legend.index = 1;
            var control = h_map.controls[google.maps.ControlPosition.RIGHT_BOTTOM];

            if ( control.length !== 0 ) {
                h_map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].pop();
            }
            h_map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
        };


        // Graphic design specification for the map
        var map_design_format = {
            // Edges
            'pipeline': {
                'name' : 'Pipeline (water/energy)',
                'existing':{
                    'name': 'Water pipeline (existing)',
    				'nameShort' : 'Water pipeline (in use)',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeColor: '#0000FF',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                },
                'candid':{
                    'name': 'Potential connection',
                    'nameShort': 'Potential connection',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeOpacity: 0,
                    strokeColor: '#000000',
                    strokeWeight: 2,
                    icons: [{ // Dashed line
                        icon: { // Define a symbol using SVG path notation, with an opacity of 1.
                            path: 'M 0,-1 0,1',
                            strokeOpacity: 1,
                            scale: 1,
                        },
                        offset: '0',
                        repeat: '10px'
                    }],
                },
                'new':{
                    'name': 'Water pipeline (new)',
                    'nameShort': 'Water pipeline (new)',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeColor: '#00FFFF',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                },
                'unused':{
                    'name': 'Water pipeline (not in use)',
                    'nameShort': 'Water pipeline (not in use)',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                },
            },
            // Nodes
            'desal': {
                'name' : 'Desalination plant',
                'existing':{
                    'name': 'Desalination plant existing',
                    'nameShort': 'Desal plant (existing)',
                    'nameShorter': 'Desal plant',
                    'image':'images/drinkingwater_green.png',
                    geodesic: true, // Do not change
                    title: '',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#0000FF',
                        fillOpacity: 1,
                        scale: 1,
                    },
                },
                'candid':{
                    'name': 'Desalination plant candidate',
                    'nameShort': 'Desal plant (planned)',
                    'image':'images/drinkingwater_red.png',
                    geodesic: true, // Do not change
                    title: '',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#bbbbbb',
                        fillOpacity: 1,
                        scale: 1,
                    },
                }
            },
            'power': {
                'name' : 'Power plant',
                'power': {
                    'nameShort': 'Power plant (existing)',
                    'nameShorter': 'Power plant',
                    'image':'images/solarenergy_blue.png',
                    geodesic: true, // Do not change
                    title: '',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillOpacity: 1,
                        fillColor: '#FFFF00',
                        scale: 1,
                    },
                }
            },
            'city': {
                'name' : 'City',
                'with_wastewater_treatment':{
                    'name': 'City with wastewater treatment',
                    'nameShort': 'City w/ WWT',
                    'image':'images/bigcity.png',
                    geodesic: true, // Do not change
                    title: '',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#00FF00',
                        fillOpacity: 1,
                        scale: 1,
                    },
                },
                'without_wastewater_treatment':{
                    'name': 'City without wastewater treatment',
                    'nameShort': 'City w/o WWT',
                    'image':'images/ghosttown.png',
                    geodesic: true, // Do not change
                    title: '',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#FF0000',
                        fillOpacity: 1,
                        scale: 1,
                    },
                }
            }
        };

        // Returns an object with the display check boxes states.
		var getSelectedCheckboxes = function (id) {
			var res = {};
            var selected = Ext.getCmp(id).getChecked();
            var sel;

			for (var i = 0; i < selected.length; i++) {
				if ( selected[i].checked ) {
                    sel = selected[i].id.replace("cb_","");
					res[ sel ] = true;
                }
			}

			return res;
		};

        // var createEdges = function (h_map,data) {
		var createEdges = function (data,markers) {
			var line = [];
			var pipe;
			var opts;
			var selected = getSelectedCheckboxes( 'cb_display_group' );

			for (var i = data.length - 1; i >= 0; i--) {
				if ( !selected.all && !selected[ data[i][0] ] )
					continue;

				// Get an options prototype:
                opts = map_design_format[ data[i][0] ][ data[i][1] ];
                line.push(new google.maps.LatLng(
                    parseFloat(data[i][2]),
                    parseFloat(data[i][3])) );
                line.push(new google.maps.LatLng(
                    parseFloat(data[i][4]),
                    parseFloat(data[i][5])) );
                opts.path = line; // Set the options variable field.

                // Create and draw the line
                pipe = new google.maps.Polyline( opts );

                pipe.node_type = data[i][0];

                markers.push(pipe);

                line.length = 0;
            }
        };

        // Inputs format:
        //      'data':
        //          [0] node_type,
        //          [1] condition,
        //          [2] lat,
        //          [3] lon,
        //          [4] value,
        //          [5] node_capacity,
        //          [6] node_id,
        //          [7] node_name,
        //          [8] Region,
        // Outputs format:
        //      'markers':
        //          node_type,
        //          node_name,
        //          node_capacity,
        var createNodes = function (data,markers) {
            var selected = getSelectedCheckboxes( 'cb_display_group' );
            var node;
            var opts;

            for (var i = data.length - 1; i >= 0; i--) {
                if ( !selected.all && !selected[ data[i][0] ] )
                    continue;

                // Get an options prototype:
                opts = '';
                opts = map_design_format[ data[i][0] ][ data[i][1] ];

                var pos = new google.maps.LatLng(
                    parseFloat(data[i][2]),
                    parseFloat(data[i][3]) );

                opts.position = pos;
                opts.icon.scale = data[i][4]; // Marker size
                opts.title = data[i][7]; // Node title

                // Add the circle for this city to the map.
				node = new google.maps.Marker( opts );

                node.node_type = data[i][0];
                node.node_name = data[i][7];
                node.node_capacity = data[i][5];

				markers.push( node );
			}
		};


        var info_window = Ext.create('Ext.window.Window', {
            title: 'Hello',
            height: 200,
            width: 400,
            // layout: 'fit',
            closeAction: 'hide',
            // items: [{  // Let's put an empty grid in just to illustrate fit layout
                // xtype: 'box',
                border: true,
                html: 'Hola mundo.',
            // }],
        });
        function showNodeInfoWindow(i) {
            return function() {
                info_window.html += 'i:' + i;
                info_window.show();
            };
        }
        var createNodeInfoWindows = function (data,h_map,markers) {
            function infoWindowFn(h_map,marker,i) {
                return function () {
                    var node_type = marker.node_type;
                    var node_name = marker.node_name;
                    var node_capacity = marker.node_capacity;
                    var node_population = marker.node_population;
                    var node_water_demand = marker.node_water_demand;

                    var contentString = ''+
                    '<div id="content">'+
                        '<div id="siteNotice">'+
                        '</div>'+
                        '<h1 id="firstHeading" class="firstHeading">'+
                            // 'Uluru'+
                            node_name+
                        '</h1>'+
                        '<div id="bodyContent">';

                    if (node_type === 'power' ) {
                        contentString += ''+
                            '<p>'+
                                '<b>Capacity</b> '+
                                node_capacity+
                                ' MW'+
                            '</p>';
                    } else if ( node_type === 'desal' ) {
                        contentString += ''+
                            '<p>'+
                                '<b>Capacity</b> '+
                                node_capacity+
                                ' m^3/day'+
                            '</p>';
                    } else if ( node_type === 'city' ) {
                        contentString += ''+
                            '<p>'+
                                '<b>Population</b> '+
                                node_population+
                                ' habitants'+
                            '</p>'+
                            '<p>'+
                                '<b>Water demand</b> '+
                                node_water_demand+
                                ' m^3/day'+
                            '</p>';
                    }

                    contentString += ''+
                        '</div>'+
                    '</div>';

                    var infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    infowindow.open( h_map, marker );
                };
            }

            for (var i = 0; i < markers.length; i++) {
                if ( markers[i].node_type === 'pipeline' )
                    continue;

                google.maps.event.addListener(
                    markers[i],
                    'click',
                    infoWindowFn(h_map,markers[i],i)
                    // showNodeInfoWindow(i)
                );
                // Set mouseover event for each feature.
                // map.data.addListener('mouseover', function(event) {
                //     document.getElementById('info-box').textContent =
                //         event.feature.getProperty('letter');
                // });
            }
        };

        // Sets the map on all markers in the array.
        function setAllMap(h_map,markers) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(h_map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers(markers) {
            setAllMap(null,markers);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers(markers) {
            clearMarkers(markers);
            // markers = []; // Does not empty the array.
            while (markers.pop()); // This does.
        }

		function plotMap(h_map,raw_data,markers) {
			var edges = raw_data.msg.data.outputs.edges;
			var nodes = raw_data.msg.data.outputs.nodes;

            // Remove old markers and lines
            deleteMarkers(markers);

            // Create graph elements
		    createEdges(edges,markers);
            createNodes(nodes,markers);

            // Draw markers and lines on the map
            setAllMap(h_map,markers);

            // Create Info windows for nodes
            createNodeInfoWindows(nodes, h_map, markers);
		}

        var updateIndicators = function (data) {
            Ext.getCmp('OptiTermDueTo').setValue( data.msg.data.outputs.cplex.cplexstatusmsg );
            Ext.getCmp('kpi_cost').setValue( data.msg.data.outputs.indicators.cost );
            Ext.getCmp('kpi_CAPEX').setValue( data.msg.data.outputs.indicators.CAPEX );
            Ext.getCmp('kpi_OPEX').setValue( data.msg.data.outputs.indicators.OPEX );
            Ext.getCmp('kpi_CO2').setValue( data.msg.data.outputs.indicators.CO2 );
            Ext.getCmp('kpi_potable').setValue( data.msg.data.outputs.indicators.potable );
            Ext.getCmp('kpi_totalLossWater').setValue( data.msg.data.outputs.indicators.totalLossWater );
            Ext.getCmp('kpi_electricity').setValue( data.msg.data.outputs.indicators.electricity );

            // Update graph
            records_costs = [];
            records_costs.push({
                ind: 'CAPEX', value: data.msg.data.outputs.indicators.CAPEX,
            });
            records_costs.push({
                ind: 'OPEX', value: data.msg.data.outputs.indicators.OPEX,
            });
            //update the store with the data that we got
            total_cost_store.loadData( records_costs );
        };

        // Generate a unique Simulation ID
        generateSimID();

        // TODO:
        //      Generate a new Sim ID when the current simulation ends OK.


        // load initial state or default data
        // var h_map = Ext.getCmp('googleMap_initial').gmap;
        // showInitialNetwork(h_map);
        showInitialNetwork( Ext.getCmp('googleMap_initial').gmap );


		//
        // from: index.html
        //////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////

    } // launch


});

   </script>
    </head>
    <body></body>
	</html>
