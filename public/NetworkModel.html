<!DOCTYPE html>
<html>
    <head>
        <title>Network Model</title>
		<script type="text/javascript" src="js/ext/build/ext-all.js"></script>
        <link rel="stylesheet" type="text/css" href="js/ext/packages/ext-theme-neptune/build/resources/ext-theme-neptune-all.css">
		<link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="js/ext/src/ux/statusbar/css/statusbar.css" />
		<script type="text/javascript" src="js/ext/packages/ext-theme-neptune/build/ext-theme-neptune.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
        <script src="js/UUID.js/dist/uuid.core.js">// If you only need UUID.generate() method </script>


<script>

var timeout_tol = 10000; // {ms} XHR calls timeout tolerance.

Ext.Loader.setConfig({enabled: true});
Ext.Loader.setPath('Ext.ux', 'js/ext/src/ux');
Ext.require([
    'Ext.ux.GMapPanel', // Alternative: https://gist.github.com/minibikini/1160378
    'Ext.ux.statusbar.StatusBar',
]);

Ext.application({
    name: 'MyApp',

    launch: function () {

        var runModel;
        var initial_network;
        var current_network;
        var simulation_result;

        Ext.getBody().setStyle('overflow', 'auto');

        // Generate a unique simulation identifier
        var generateSimID = function () {
            var simID = Ext.getCmp('simID');
            simID.setValue( UUID.generate() );
        };

		var bt_uploadHandler = function () {
		    var form = this.up('form').getForm();
		    if (form.isValid()) {
		        form.submit({
		            url: 'php', // Server API to upload a file
		            waitMsg: 'Uploading your file...',
		            success: function (fp, o) {
		                Ext.Msg.alert('Success', 'Your file "' + o.result.file + '" has been uploaded.');
		            }
		        });
		    }
		};

        function fn_display_mode_changed() {
            if ( this.getValue() ){
                Ext.getCmp('cb_all').setValue(false);
            }

            var h_map = Ext.getCmp('googleMap').gmap;
            plotMap(h_map,current_network);
        }

        // main panel
        var childPanel1 = Ext.create('Ext.panel.Panel', {
            extend: 'Ext.container.Viewport',
            layout: 'border',
            height: 750,
            width: 1400,
            items: [{ // main north panel
                region: 'north',
                html: '<h1>KSA Water/Energy INFINT Model 1.0</h1>',
                style: {
                    'text-align': 'center',
                    marginBottom: '10px',
                }
            }, { // main west panel
                region: 'west',
                width: 300,
                bodyPadding: 5,
                items: [{
                    title: 'User info',
                    split: true,
                    bodyPadding: 5,
                    frame: true,
                    items: [{
                        defaultType: 'textfield',
                        items: [{
                            fieldLabel: 'User ID',
                            id: 'userID',
                            name: 'userID',
                            value: 1,
                            readOnly: true,
                            width: '100%',
                        }, {
                            fieldLabel: 'Simulation ID',
                            id: 'simID',
                            name: 'simID',
                            value: 123,
                            readOnly: true,
                            width: '100%',
                        }, {
                            fieldLabel: 'Session',
                            id: 'sessionID',
                            name: 'sessionID',
                            value: 123,
                            readOnly: true,
                            width: '100%',
                        }]
                    }]
                }, {
                    // west panel #1 for loading the database
                    region: 'west',
                    title: 'Step 1: Database ',
                    split: true,
                    bodyPadding: 5,
                    frame: true,
                    items: [{
                        xtype      : 'fieldcontainer',
                        fieldLabel : 'Use database',
                        defaultType: 'radiofield',
                        layout: 'hbox',
                        items: [{
                            boxLabel  : 'Default',
                            name      : 'db_src',
                            inputValue: 'src_default',
                            id        : 'radio1',
                            checked: true,
                        }, {
                            boxLabel  : 'New',
		                    name      : 'db_src',
		                    inputValue: 'src_new_file',
		                    id        : 'radio2'
		                }]
                    }, {
                        xtype: 'filefield',
                        width: '100%',
                        name: 'file',
                        msgTarget: 'side',
                        allowBlank: false,
                        anchor: '100%',
                        buttonText: 'Select File',
                        disabled: true,
                    }, {
                        xtype: 'button',
                        text: 'Upload',
                        id: 'b_upload_file',
                        disabled: true,
                        handler: function() {
                            bt_uploadHandler();
                        },
                    }]
                }, {
                    // west panel #2 for inputs
                    region: 'west',
                    title: 'Step 2: Optimization ',
                    split: true,
                    bodyPadding: 5,
                    frame: true,
                    items: [{
                        html: '<p>Optimize Network Flow under:</p>',
                    }, {
                        // TODO:
                        //      Append the current slider value
                        //      at the end of the label.
                        //      http://jsfiddle.net/molecule/WdjZn/
                        //      http://www.sencha.com/forum/showthread.php?184084-Display-slider-value
                        xtype: 'sliderfield',
                        fieldLabel: 'Cost (%)',
                        // labelStyle: 'color:gray; margin-bottom:0px;',
                        // afterLabelTextTpl: this.getValue()+'%',
                        id: 's_cost',
                        width: '100%',
                        value: 100,
                        minValue: 0,
                        maxValue: 100,
                        listeners: {
                            change: function( slider, newValue, thumb, eOpts ) {
                                Ext.getCmp('s_co2').setValue(100 - slider.getValue());
                            },
                        },
                    }, {
                        xtype: 'sliderfield',
                        fieldLabel: 'CO2 (%)',
                        id: 's_co2',
                        width: '100%',
                        value: 0,
                        minValue: 0,
                        maxValue: 100,
                        listeners: {
                            change: function( slider, newValue, thumb, eOpts ) {
                                Ext.getCmp('s_cost').setValue(100 - slider.getValue());
                            },
                        },
                    }, {
                        defaultType: 'textfield',
                        items: [{
                            fieldLabel: 'Time Limit (Seconds)',
                            id: 'timelimit',
                            name: 'TimeLimit',
                            value: 30,
                            width: '100%',
                        }, {
                            fieldLabel: 'Optimality Gap',
                            id: 'optimality',
                            name: 'optimalityGap',
                            value: 0.03,
                            width: '100%',
                        }]
                    }, {
                        xtype: 'button',
                        text: 'Run',
                        id: 'b_run_model',
                        handler: function() {
                            runModel();
                        },
                    }, {
                        xtype: 'statusbar',
                        id: 'sb_run_status',
                        width: 220,
                        statusAlign: 'right', // the magic config
                        // defaults to use when the status is cleared:
                        defaultText: 'Ready',
                        defaultIconCls: 'default-icon',
                        style: {
                            display: 'inline-block',
                        },
                    }],
                }],
            }, { // main center panel
                itemId: 'centerregion',
                region: 'center',
                bodyPadding: 5,
                items: [{ // center panel #1 -> google map + display modes
                    itemId: 'centerregion',
                    frame: 'true',
                    height: 550,
                    layout:'fit',
                    items: [{
                        xtype: 'gmappanel',
						gmapType: 'map',
						id: 'googleMap',
						center: {
							lat: 24.7,
							lng: 46.7,
						},
						// mapConfOpts: ['enableScrollWheelZoom','enableDoubleClickZoom','enableDragging'],
						mapOptions: {
							zoom: 5,
							mapTypeId: google.maps.MapTypeId.ROADMAP,
                            styles: [{ // Wizard: http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html
                                "stylers": [
                                  { "visibility": "off" }
                                ]
                              },{
                                "featureType": "administrative.country",
                                "elementType": "geometry.stroke",
                                "stylers": [
                                  { "visibility": "on" }
                                ]
                              },{
                                "featureType": "administrative.country",
                                "elementType": "labels.text",
                                "stylers": [
                                  { "visibility": "on" }
                                ]
                              },{
                                "featureType": "water",
                                "elementType": "geometry.fill",
                                "stylers": [
                                  { "visibility": "on" }
                                ]
                              },{
                                "featureType": "administrative.locality",
                                "elementType": "labels.icon",
                                "stylers": [
                                  { "color": "#808080" },
                                  { "visibility": "simplified" }
                                ]
                              },{
                                "featureType": "administrative.locality",
                                "elementType": "labels.text",
                                "stylers": [
                                  { "visibility": "on" }
                                ]
                              },{
                            }]
						}
                	}]
                }, {
                    bodyPadding: 5,
                    items: [{
                        xtype: 'checkboxgroup',
                        fieldLabel: 'Display Modes',
                        id: 'cb_display_group',
                        name: 'cb_display_group',
                        columns: 5,
                        bodyPadding: 5,
                        items: [{
                            boxLabel: 'All ',
                            id: 'cb_all',
                            name: 'cb_display',
                            inputValue: '1',
                            checked: true,
                            handler: function () {
                                if ( this.getValue() ){
                                    Ext.getCmp('cb_pipeline').setValue(false);
                                    Ext.getCmp('cb_city').setValue(false);
                                    Ext.getCmp('cb_power').setValue(false);
                                    Ext.getCmp('cb_desal').setValue(false);
                                }

                                var h_map = Ext.getCmp('googleMap').gmap;
                                plotMap(h_map,current_network);
                            }
                        }, {
                            boxLabel: 'Pipelines',
                            id: 'cb_pipeline',
                            name: 'cb_display',
                            inputValue: '2',
                            handler: fn_display_mode_changed,
                        }, {
                            boxLabel: 'City',
                            id: 'cb_city',
                            name: 'cb_display',
                            inputValue: '3',
                            handler: fn_display_mode_changed,
                        }, {
                            boxLabel: 'Power Plant',
                            id: 'cb_power',
                            name: 'cb_display',
                            inputValue: '4',
                            handler: fn_display_mode_changed,
                        }, {
                            boxLabel: 'Desalination Plant',
                            id: 'cb_desal',
                            name: 'cb_display',
                            inputValue: '5',
                            handler: fn_display_mode_changed,
                        }, {
                            boxLabel: 'Legend',
                            id: 'cb_legend',
                            name: 'cb_display',
                            inputValue: '6',
                            checked: true,
                            handler: function () {
                                if ( this.getValue() ) { // Show legend
                                    Ext.get('legend').setStyle('display', 'block');
                                } else { // Hide legend
                                    Ext.get('legend').setStyle('display','none');
                                }
                            }
                        }],
                    }],
                }]
            }, { // main East panel
                region: 'east',
                width: 300,
                bodyPadding: 5,
                items: [{
                    // east panel #1 shows results
                    title: 'Results',
                    split: false,
                    bodyPadding: 5,
                    frame: true,
                    items: [{
                        defaultType: 'textfield',
                        items: [{
                            fieldLabel: 'Optimization terminated due to',
                            id: 'OptiTermDueTo',
                            name: 'OptiTermDueTo',
                            readOnly: true,
                            value: 'Not started',
                            width: '100%',
                        }, {
                            fieldLabel: 'Total Cost (MUSD/year)',
                            id: 'kpi_cost',
                            name: 'TotalCost',
                            readOnly: true,
                            value: '0.0',
                            width: '100%',
                        }, {
                            fieldLabel: 'Total CAPEX (MUSD/year)',
                            id: 'kpi_CAPEX',
                            name: 'TotalCAPEX',
                            readOnly: true,
                            value: '0.0',
                            width: '100%',
                        }, {
                            fieldLabel: 'Total OPEX (MUSD/year)',
                            id: 'kpi_OPEX',
                            name: 'TotalOPEX',
                            readOnly: true,
                            value: '0.0',
                            width: '100%',
                        }, {
                            fieldLabel: 'Total CO2 Emission (MMT/year)',
                            id: 'kpi_CO2',
                            name: 'TotalCO2',
                            readOnly: true,
                            value: '0.0',
                            width: '100%',
                        }, {
                            fieldLabel: 'Total Potable Water Production (MCM/year)',
                            id: 'kpi_potable',
                            name: 'TotalPotableWater',
                            readOnly: true,
                            value: '0.0',
                            width: '100%',
                        }, {
                            fieldLabel: 'Total Water loss in Pipeline (%)',
                            id: 'kpi_totalLossWater',
                            name: 'TotalWaterLoss',
                            readOnly: true,
                            value: '0.0',
                            width: '100%',
                        }, {
                            fieldLabel: 'Total Electricity Generation (GWh/year)',
                            id: 'kpi_electricity',
                            name: 'TotalElectricity',
                            readOnly: true,
                            value: '0.0',
                            width: '100%',
                        }]
                    }]
                }]
            }]
        }); // childPanel1

        // New pareto graph
        //  xlabel: 'Total Cost (CAPEX+OPEX) [BUSD/year]'
        //  ylabel: 'Total CO2 Emission [MMT/year]'

        Ext.create('Ext.container.Viewport', {
            items: [childPanel1]
        });


        //////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////
        // from: index.html
        //

		var map_handler = {"map":null,"options":null};
		var markers = [];

		var domain_name = window.location.hostname;
		var server_addr = domain_name + ':8080';

		var showInitialNetwork = function (h_map) {
		    var resource = 'http://' + server_addr + '/initial_network?'+
                'inputfile=Default';

            // Request user data through an XHR.
            Ext.Ajax.request({
                url: resource,
                success: function(response, opts) {
                    var obj = Ext.decode(response.responseText);
                    // Backup results gotten from the server.
                    initial_network = obj;
                    current_network = initial_network;

    				plotMap(h_map,current_network);
                    insertLegend(h_map,current_network);
                },
                failure: function(response, opts) {
                    console.log('server-side failure with status code ' + response.status);
                }
            });
        };

        runModel = function() {
            Ext.getCmp('b_run_model').setDisabled(true);
            var sb = Ext.getCmp('sb_run_status');
            sb.showBusy('Running simulation...'); // Set the status bar to show that something is processing:

            var in_userID = Ext.getCmp('userID').getValue().trim();
            var in_simID = Ext.getCmp('simID').getValue().trim();
            var in_sessionID = Ext.getCmp('sessionID').getValue().trim();
            var in_cost = Ext.getCmp('s_cost').getValue()/100;
            var in_co2 = Ext.getCmp('s_co2').getValue()/100;
            var in_timelimit = Ext.getCmp('timelimit').getValue().trim();
            var in_optimality = Ext.getCmp('optimality').getValue().trim();

            var resource = 'http://' + server_addr + '/output?' +
                        'userID=' + in_userID +
                        '&simID=' + in_simID +
                        '&sessionID=' + in_sessionID +
                        '&cost=' + in_cost +
                        '&co2=' + in_co2 +
                        '&timelimit=' + in_timelimit +
                        '&optimality=' + in_optimality;
            // console.log('resource: ' + resource);

            var total_timeout = in_timelimit + timeout_tol;

            // Request user data through an XHR.
            Ext.Ajax.request({
                url: resource,
                timeout: total_timeout,
                success: function(response, opts) {
                    var obj = Ext.decode(response.responseText);
                    // console.dir(obj);

                    // Backup results gotten from the server.
                    current_network = obj;

                    plotMap(h_map,current_network);
                    insertLegend(h_map,current_network);
                    updateIndicators(current_network);

                    console.log('stdout: '+ current_network.msg.stdout);
                    console.log('stderr: '+ current_network.msg.stderr);
                    // Done.

                    // Generate a new unique Simulation ID
                    generateSimID();
                    // and enable the run button
                    Ext.getCmp('b_run_model').setDisabled(false);
                    sb.setStatus({
                        iconCls: 'x-status-valid',
                        text: 'Finished',
                    });
                },
                failure: function(response, opts) {
                    console.log('server-side failure with status code: ' + statusText + ' (Code '+ response.status + ')');
                    console.dir(response);
                    // Generate a new unique Simulation ID
                    generateSimID();
                    // and enable the run button
                    Ext.getCmp('b_run_model').setDisabled(false);
                    sb.setStatus({
                        iconCls: 'x-status-error',
                        text: 'Finished with error',
                    });
                }
            });
        };

        // var insertLegend = function (h_map) {
        var insertLegend = function (h_map,current_network) {
            var legend,
				content = [],
                elem,
                radius = 5,
                initial_network;

			// Create the legend and display on the map
			legend = document.createElement('div');
			legend.id = 'legend';
			content.push('<h3>Legend</h3>');

            initial_network = ( current_network.msg.data.id !== undefined && current_network.msg.data.id === "initial_network" );
            elem = map_design_format.city.with_wastewater_treatment;
            content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
            elem = map_design_format.city.without_wastewater_treatment;
            content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");

            if ( initial_network ) {
                elem = map_design_format.desal.existing;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
                elem = map_design_format.desal.candid;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
            } else {
                elem = map_design_format.desal.existing;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShorter + "</p>");
            }

            if ( initial_network ) {
                elem = map_design_format.power.power;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShort + "</p>");
            } else {
                elem = map_design_format.power.power;
                content.push("<p><svg height='10' width='10'><circle cx='"+radius+"' cy='"+radius+"' r='"+radius+"' stroke='"+elem.icon.strokeColor+"' stroke-width='"+elem.icon.strokeWeight+"' fill='"+elem.icon.fillColor+"' /></svg>  "+ elem.nameShorter + "</p>");
            }

            if ( initial_network ) {
                elem = map_design_format.pipeline.existing;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.name + "</p>");
                elem = map_design_format.pipeline.candid;
                content.push("<p><svg height='5' width='15'>"+
                    "<rect x='0' y='0' height='5' width='5' fill='"+elem.strokeColor+"' />"+
                    "<rect x='5' y='0' height='5' width='5' fill='#FFFFFF' />"+
                    "<rect x='10' y='0' height='5' width='5' fill='"+elem.strokeColor+"' />"+
                    "</svg>  "+ elem.nameShort + "</p>");
            } else {
                elem = map_design_format.pipeline.existing;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.nameShort + "</p>");
                elem = map_design_format.pipeline.new;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.nameShort + "</p>");
                elem = map_design_format.pipeline.unused;
                content.push("<p><svg height='5' width='10'><rect height='5' width='10' fill='"+elem.strokeColor+"' /></svg>  "+ elem.nameShort + "</p>");
            }

            legend.innerHTML = content.join('');
            legend.index = 1;
            h_map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].pop();
            h_map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
        };


        // Graphic design specification for the map
        var map_initial_node_scale = 1;
        var map_design_format = {
            // Edges
            'pipeline': {
                'name' : 'Pipeline (water/energy)',
                'existing':{
                    'name': 'Water pipeline (existing)',
    				'nameShort' : 'Water pipeline (in use)',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeColor: '#0000FF',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                },
                'candid':{
                    'name': 'Potential connection',
                    'nameShort': 'Potential connection',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeOpacity: 0,
                    strokeColor: '#000000',
                    strokeWeight: 2,
                    icons: [{ // Dashed line
                        icon: { // Define a symbol using SVG path notation, with an opacity of 1.
                            path: 'M 0,-1 0,1',
                            strokeOpacity: 1,
                            scale: 1,
                        },
                        offset: '0',
                        repeat: '10px'
                    }],
                },
                'new':{
                    'name': 'Water pipeline (new)',
                    'nameShort': 'Water pipeline (new)',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeColor: '#00FFFF',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                },
                'unused':{
                    'name': 'Water pipeline (not in use)',
                    'nameShort': 'Water pipeline (not in use)',
                    path: [], // Do not change
                    geodesic: true, // Do not change
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                },
            },
            // Nodes
            'desal': {
                'name' : 'Desalination plant',
                'existing':{
                    'name': 'Desalination plant existing',
                    'nameShort': 'Desal plant (existing)',
                    'nameShorter': 'Desal plant',
                    'image':'images/drinkingwater_green.png',
                    geodesic: true, // Do not change
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#0000FF',
                        fillOpacity: 1,
                        scale: 1, // map_initial_node_scale,
                    },
                },
                'candid':{
                    'name': 'Desalination plant candidate',
                    'nameShort': 'Desal plant (planned)',
                    'image':'images/drinkingwater_red.png',
                    geodesic: true, // Do not change
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#bbbbbb',
                        fillOpacity: 1,
                        scale: 1, // map_initial_node_scale,
                    },
                }
            },
            'power': {
                'name' : 'Power plant',
                'power': {
                    'nameShort': 'Power plant (existing)',
                    'nameShorter': 'Power plant',
                    'image':'images/solarenergy_blue.png',
                    geodesic: true, // Do not change
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillOpacity: 1,
                        fillColor: '#FFFF00',
                        scale: 1, // map_initial_node_scale,
                    },
                }
            },
            'city': {
                'name' : 'City',
                'with_wastewater_treatment':{
                    'name': 'City with wastewater treatment',
                    'nameShort': 'City w/ WWT',
                    'image':'images/bigcity.png',
                    geodesic: true, // Do not change
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#00FF00',
                        fillOpacity: 1,
                        scale: 1, // map_initial_node_scale,
                    },
                },
                'without_wastewater_treatment':{
                    'name': 'City without wastewater treatment',
                    'nameShort': 'City w/o WWT',
                    'image':'images/ghosttown.png',
                    geodesic: true, // Do not change
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        strokeColor: '#000000',
                        strokeOpacity: 1,
                        strokeWeight: 1,
                        fillColor: '#FF0000',
                        fillOpacity: 1,
                        scale: 1, // map_initial_node_scale,
                    },
                }
            }
        };

        // Returns an object with the display check boxes states.
		var getSelectedCheckboxes = function (id) {
			var res = {};
            var selected = Ext.getCmp('cb_display_group').getChecked();

			for (var i = 0; i < selected.length; i++) {
				if ( selected[i].checked )
					res[selected[i].id.replace("cb_","")] = true;
			}

			return res;
		};

        // var createEdges = function (h_map,data) {
		var createEdges = function (data) {
			var line = [];
			var pipe;
			var opts;
			var selected = getSelectedCheckboxes( "output_selector" );

			for (var i = data.length - 1; i >= 0; i--) {
				if ( !selected.all && !selected[ data[i][0] ] )
					continue;

				// Get an options prototype:
                opts = map_design_format[ data[i][0] ][ data[i][1] ];
                line.push(new google.maps.LatLng(
                    parseFloat(data[i][2]),
                    parseFloat(data[i][3])) );
                line.push(new google.maps.LatLng(
                    parseFloat(data[i][4]),
                    parseFloat(data[i][5])) );
                opts.path = line; // Set the options variable field.

                // Create and draw the line
                pipe = new google.maps.Polyline( opts );

                markers.push(pipe);

                line.length = 0;
            }
        };

        var createNodes = function (data) {
            var selected = getSelectedCheckboxes( "output_selector" );
            var node;
            var opts;

            for (var i = data.length - 1; i >= 0; i--) {
                if ( !selected.all && !selected[ data[i][0] ] )
                    continue;

                // Get an options prototype:
                opts = '';
                opts = map_design_format[ data[i][0] ][ data[i][1] ];

                var pos = new google.maps.LatLng(
                    parseFloat(data[i][2]),
                    parseFloat(data[i][3]) );

                opts.position = pos;
                // opts.radius = 10000;
                opts.icon.scale = data[i][4]; // Set the options variable field.
// console.log(opts.icon.scale);
// if (opts.icon.scale >= 20)
// console.log(data[i]);

                // Add the circle for this city to the map.
				node = new google.maps.Marker( opts );

				markers.push( node );
			}
		};

        // Sets the map on all markers in the array.
        function setAllMap(h_map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(h_map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setAllMap(null);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }

		function plotMap(h_map,raw_data) {
			var edges = raw_data.msg.data.outputs.edges;
			var nodes = raw_data.msg.data.outputs.nodes;

            // Remove old markers and lines
            deleteMarkers();

            // Create graph elements
		    createEdges(edges);
		    createNodes(nodes);

            // Draw markers and lines on the map
            setAllMap(h_map);
		}

        var updateIndicators = function (data) {
            Ext.getCmp('OptiTermDueTo').setValue( data.msg.data.outputs.cplex.cplexstatusmsg );
            Ext.getCmp('kpi_cost').setValue( data.msg.data.outputs.indicators.cost );
            Ext.getCmp('kpi_CAPEX').setValue( data.msg.data.outputs.indicators.CAPEX );
            Ext.getCmp('kpi_OPEX').setValue( data.msg.data.outputs.indicators.OPEX );
            Ext.getCmp('kpi_CO2').setValue( data.msg.data.outputs.indicators.CO2 );
            Ext.getCmp('kpi_potable').setValue( data.msg.data.outputs.indicators.potable );
            Ext.getCmp('kpi_totalLossWater').setValue( data.msg.data.outputs.indicators.totalLossWater );
            Ext.getCmp('kpi_electricity').setValue( data.msg.data.outputs.indicators.electricity );
        };

        // Generate a unique Simulation ID
        generateSimID();

        // TODO:
        //      Generate a new Sim ID when the current simulation ends OK.


        // load initial state or default data
        var h_map = Ext.getCmp('googleMap').gmap;
        showInitialNetwork(h_map);


		//
        // from: index.html
        //////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////

    } // launch


});

   </script>
    </head>
    <body></body>
	</html>
